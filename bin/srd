#!/bin/bash

HERE=$( dirname -- "$( realpath -- "$0"; )"; )
BASE=$( realpath -- "$HERE/../" )
TEMPLATES_DIR="$BASE/templates"
DATA_DIR="$BASE/data"
CACHE_FILE="$BASE/bin/_temp.yml"

containsElement () (
	local e match="$1"
	shift
	for e; do [[ "$e" == "$match" ]] && return 0; done
	return 1
)

help () (
	object_type_list="Card, Challenge_Type, Conversation, Exit, Item, Location, Person, Vending"
	messages=(
		"srd <command>\n"
		"\t- help / --help / -h: Displays this message.\n"
		"\t- make: Creates a new data/content object.\n"
		"\t- build: Converts YML data to Rust code.\n"
		"\t- run: Runs the game.\n"
		"\t- debug: Runs the game with backtrace displayed on error.\n"
		"srd make <ObjectType>\n"
		"\tObjectType: $object_type_list\n"
		"srd search <ObjectType>\n"
		"\tObjectType: $object_type_list\n"
	)
	printf "${messages[*]}"
)

error() (
	local error_message=$1
	printf "Error: $error_message\n\n"
	help
	exit 1
)

get_id() (
	date +%s
)

make_cache() (
	if [ ! -f bin/_temp.yml ]; then
		CACHE_TIME=0
	else
		CACHE_TIME=$(stat -c '%Y' $CACHE_FILE)
	fi

	LATEST_FILE=$(ls -lt $DATA_DIR/*.yml | head -n 1 | awk '{print $9}')
	LATEST_CHANGE_TIME=$(stat -c '%Y' $LATEST_FILE)

	if [[ $CACHE_TIME -lt $LATEST_CHANGE_TIME ]]; then
		echo '' > $CACHE_FILE
		for f in $DATA_DIR/*yml; do
			cat $f >> $CACHE_FILE
			printf "\n---\n\n" >> $CACHE_FILE
		done
	fi
)

search() (
	# yq 'select(.type == "Conversation") | .speaker' bin/_temp.yml
	# ag -l 'id: 1754951881'
	type=$1
	for id in `yq "select(.type == \"$type\") .id" $CACHE_FILE`; do
		for file in `ag -l "id: $id" data`; do
			echo $file
			pygmentize -g $file
			echo ""
		done
	done
)

HELP_OPTIONS=("help" "--help" "-h")

command=$1
if $(containsElement "$command" "${HELP_OPTIONS[@]}"); then
	help
elif [[ "$command" == "make" ]]; then
	next_id=$(get_id)
	template_kind="$2"
	if [[ -z "$template_kind" ]];then
		error "No object type provided"
	fi
	template_file="$TEMPLATES_DIR/$template_kind.yml"
	if [[ -f "$template_file" ]]; then
		FILE_NAME="$DATA_DIR/${template_kind}s/$next_id.yml"
		sed "s/\$SRD_ID0/$next_id/" $template_file > $FILE_NAME
		if [[ "$template_kind" == "conversation" ]]; then
			id=$(($next_id))
			id=$(($id+1))
			sed -i "s/\$SRD_ID1/$id/" $FILE_NAME
			id=$(($id+1))
			sed -i "s/\$SRD_ID2/$id/" $FILE_NAME
		fi
		echo "$FILE_NAME"
	else
		error "No type '$template_kind'"
	fi
elif [[ "$command" == "build" ]]; then
	cd builder
	cargo run
	cd ..
elif [[ "$command" == "debug" ]]; then
	cd game
	RUST_BACKTRACE=1 cargo run
	cd ..
elif [[ "$command" == "run" ]]; then
	cd game
	SRD_DEV=1 cargo run
	cd ..
elif [[ "$command" == "search" ]]; then
	make_cache
	type="${2^}"
	search $type | less
else
	error "No arguments given"
fi
